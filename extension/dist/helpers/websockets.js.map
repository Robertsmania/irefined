{"version":3,"file":"websockets.js","sources":["../../src/helpers/websockets.js"],"sourcesContent":["import { io } from \"socket.io-client\";\r\nimport { v4 } from 'uuid';\r\nimport { log } from \"../features/logger.js\";\r\n\r\nlet wsInitCheck = setInterval(() => {\r\n    if (SENTRY_RELEASE) {\r\n        clearInterval(wsInitCheck);\r\n        initWS();\r\n    }\r\n}, 1000);\r\n\r\nlet clientSocket;\r\nlet callbacks = [];\r\n\r\nfunction initWS() {\r\n    const irVersion = SENTRY_RELEASE.id.substring(0, SENTRY_RELEASE.id.indexOf(\"-\"));\r\n\r\n    const authSocket = io(\"https://members-ng.iracing.com\", {\r\n        reconnectionAttempts: 100,\r\n        auth: {\r\n            clientVersion: irVersion\r\n        },\r\n        transports: [\"websocket\"]\r\n    });\r\n\r\n    clientSocket = io(\"https://members-ng.iracing.com/client.io\", {\r\n        reconnectionAttempts: 100,\r\n        auth: {\r\n            clientVersion: irVersion\r\n        },\r\n        transports: [\"websocket\"]\r\n    });\r\n\r\n    authSocket.on(\"connect\", () => {\r\n        log(\"‚ö° Connected to iRacing WS\");\r\n    });\r\n\r\n    authSocket.on(\"disconnect\", () => {\r\n        log(\"‚õìÔ∏è‚Äçüí• Disconnected from iRacing WS\");\r\n    });\r\n\r\n\r\n    clientSocket.on(\"initialized\", (data) => {\r\n        authSocket.emit(\"now\");\r\n\r\n        clientSocket.emit(\r\n            \"data_services\",\r\n            {\r\n                \"refid\": v4(),\r\n                \"service\": \"season\",\r\n                \"method\": \"popular_sessions\",\r\n                \"args\": {\r\n                    \"include_empty_practice\": false,\r\n                    \"subscribe\": true\r\n                }\r\n            }\r\n        );\r\n    });\r\n\r\n    authSocket.on(\"heartbeat\", (data) => {\r\n        return data();\r\n    });\r\n\r\n    clientSocket.on(\"data_services_push\", (data) => {\r\n        callbacks.forEach(callback => {\r\n            callback(data);\r\n        });\r\n    });\r\n}\r\n\r\nfunction send(event, data) {\r\n    data.refid = v4();\r\n    clientSocket.emit(event, data);\r\n}\r\n\r\nfunction withdraw() {\r\n    log(\"üö´ Withdrawing from session if registered.\");\r\n    send(\r\n        \"data_services\",\r\n        {\r\n            \"service\": \"registration\",\r\n            \"method\": \"withdraw\",\r\n            \"args\": {}\r\n        }\r\n    );\r\n}\r\n\r\nfunction register(car_id, car_class_id, session_id, subsession_id = null) {\r\n\r\n    log(`üìù Registering for session ${session_id} as driver with car ${car_id}`);\r\n    \r\n    const data = {\r\n        \"service\": \"registration\",\r\n        \"method\": \"register\",\r\n        \"args\": {\r\n            \"register_as\": \"driver\",\r\n            \"car_id\": car_id,\r\n            \"car_class_id\": car_class_id,\r\n            \"session_id\": session_id\r\n        }\r\n    };\r\n\r\n    if (subsession_id) {\r\n        data.args.subsession_id = subsession_id;\r\n    }\r\n\r\n    send( \"data_services\", data);\r\n}\r\n\r\nconst ws = {\r\n    send,\r\n    register,\r\n    withdraw,\r\n    callbacks\r\n};\r\n\r\nexport default ws;\r\n"],"names":["wsInitCheck","initWS","clientSocket","callbacks","irVersion","authSocket","io","log","data","v4","callback","send","event","withdraw","register","car_id","car_class_id","session_id","subsession_id","ws"],"mappings":";;;AAIA,IAAIA,IAAc,YAAY,MAAM;AAChC,EAAI,mBACA,cAAcA,CAAW,GACzBC;AAER,GAAG,GAAI,GAEHC,GACAC,IAAY,CAAA;AAEhB,SAASF,IAAS;AACd,QAAMG,IAAY,eAAe,GAAG,UAAU,GAAG,eAAe,GAAG,QAAQ,GAAG,CAAC,GAEzEC,IAAaC,EAAG,kCAAkC;AAAA,IACpD,sBAAsB;AAAA,IACtB,MAAM;AAAA,MACF,eAAeF;AAAA,IAClB;AAAA,IACD,YAAY,CAAC,WAAW;AAAA,EAChC,CAAK;AAED,EAAAF,IAAeI,EAAG,4CAA4C;AAAA,IAC1D,sBAAsB;AAAA,IACtB,MAAM;AAAA,MACF,eAAeF;AAAA,IAClB;AAAA,IACD,YAAY,CAAC,WAAW;AAAA,EAChC,CAAK,GAEDC,EAAW,GAAG,WAAW,MAAM;AAC3B,IAAAE,EAAI,2BAA2B;AAAA,EACvC,CAAK,GAEDF,EAAW,GAAG,cAAc,MAAM;AAC9B,IAAAE,EAAI,oCAAoC;AAAA,EAChD,CAAK,GAGDL,EAAa,GAAG,eAAe,CAACM,MAAS;AACrC,IAAAH,EAAW,KAAK,KAAK,GAErBH,EAAa;AAAA,MACT;AAAA,MACA;AAAA,QACI,OAASO,EAAI;AAAA,QACb,SAAW;AAAA,QACX,QAAU;AAAA,QACV,MAAQ;AAAA,UACJ,wBAA0B;AAAA,UAC1B,WAAa;AAAA,QAChB;AAAA,MACJ;AAAA,IACb;AAAA,EACA,CAAK,GAEDJ,EAAW,GAAG,aAAa,CAACG,MACjBA,EAAI,CACd,GAEDN,EAAa,GAAG,sBAAsB,CAACM,MAAS;AAC5C,IAAAL,EAAU,QAAQ,CAAAO,MAAY;AAC1B,MAAAA,EAASF,CAAI;AAAA,IACzB,CAAS;AAAA,EACT,CAAK;AACL;AAEA,SAASG,EAAKC,GAAOJ,GAAM;AACvB,EAAAA,EAAK,QAAQC,KACbP,EAAa,KAAKU,GAAOJ,CAAI;AACjC;AAEA,SAASK,IAAW;AAChB,EAAAN,EAAI,4CAA4C,GAChDI;AAAA,IACI;AAAA,IACA;AAAA,MACI,SAAW;AAAA,MACX,QAAU;AAAA,MACV,MAAQ,CAAE;AAAA,IACb;AAAA,EACT;AACA;AAEA,SAASG,EAASC,GAAQC,GAAcC,GAAYC,IAAgB,MAAM;AAEtE,EAAAX,EAAI,8BAA8BU,CAAU,uBAAuBF,CAAM,EAAE;AAE3E,QAAMP,IAAO;AAAA,IACT,SAAW;AAAA,IACX,QAAU;AAAA,IACV,MAAQ;AAAA,MACJ,aAAe;AAAA,MACf,QAAUO;AAAA,MACV,cAAgBC;AAAA,MAChB,YAAcC;AAAA,IACjB;AAAA,EACT;AAEI,EAAIC,MACAV,EAAK,KAAK,gBAAgBU,IAG9BP,EAAM,iBAAiBH,CAAI;AAC/B;AAEK,MAACW,IAAK;AAAA,EACP,MAAAR;AAAA,EACA,UAAAG;AAAA,EACA,UAAAD;AAAA,EACA,WAAAV;AACJ;"}