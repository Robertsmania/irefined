{"version":3,"file":"webtransport.js","sources":["../../../../../../node_modules/engine.io-client/build/esm/transports/webtransport.js"],"sourcesContent":["import { Transport } from \"../transport.js\";\nimport { nextTick } from \"../globals.node.js\";\nimport { createPacketDecoderStream, createPacketEncoderStream, } from \"engine.io-parser\";\n/**\n * WebTransport transport based on the built-in `WebTransport` object.\n *\n * Usage: browser, Node.js (with the `@fails-components/webtransport` package)\n *\n * @see https://developer.mozilla.org/en-US/docs/Web/API/WebTransport\n * @see https://caniuse.com/webtransport\n */\nexport class WT extends Transport {\n    get name() {\n        return \"webtransport\";\n    }\n    doOpen() {\n        try {\n            // @ts-ignore\n            this._transport = new WebTransport(this.createUri(\"https\"), this.opts.transportOptions[this.name]);\n        }\n        catch (err) {\n            return this.emitReserved(\"error\", err);\n        }\n        this._transport.closed\n            .then(() => {\n            this.onClose();\n        })\n            .catch((err) => {\n            this.onError(\"webtransport error\", err);\n        });\n        // note: we could have used async/await, but that would require some additional polyfills\n        this._transport.ready.then(() => {\n            this._transport.createBidirectionalStream().then((stream) => {\n                const decoderStream = createPacketDecoderStream(Number.MAX_SAFE_INTEGER, this.socket.binaryType);\n                const reader = stream.readable.pipeThrough(decoderStream).getReader();\n                const encoderStream = createPacketEncoderStream();\n                encoderStream.readable.pipeTo(stream.writable);\n                this._writer = encoderStream.writable.getWriter();\n                const read = () => {\n                    reader\n                        .read()\n                        .then(({ done, value }) => {\n                        if (done) {\n                            return;\n                        }\n                        this.onPacket(value);\n                        read();\n                    })\n                        .catch((err) => {\n                    });\n                };\n                read();\n                const packet = { type: \"open\" };\n                if (this.query.sid) {\n                    packet.data = `{\"sid\":\"${this.query.sid}\"}`;\n                }\n                this._writer.write(packet).then(() => this.onOpen());\n            });\n        });\n    }\n    write(packets) {\n        this.writable = false;\n        for (let i = 0; i < packets.length; i++) {\n            const packet = packets[i];\n            const lastPacket = i === packets.length - 1;\n            this._writer.write(packet).then(() => {\n                if (lastPacket) {\n                    nextTick(() => {\n                        this.writable = true;\n                        this.emitReserved(\"drain\");\n                    }, this.setTimeoutFn);\n                }\n            });\n        }\n    }\n    doClose() {\n        var _a;\n        (_a = this._transport) === null || _a === void 0 ? void 0 : _a.close();\n    }\n}\n"],"names":["WT","Transport","err","stream","decoderStream","createPacketDecoderStream","reader","encoderStream","createPacketEncoderStream","read","done","value","packet","packets","i","lastPacket","nextTick","_a"],"mappings":";;;AAWO,MAAMA,UAAWC,EAAU;AAAA,EAC9B,IAAI,OAAO;AACP,WAAO;AAAA,EACf;AAAA,EACI,SAAS;AACL,QAAI;AAEA,WAAK,aAAa,IAAI,aAAa,KAAK,UAAU,OAAO,GAAG,KAAK,KAAK,iBAAiB,KAAK,IAAI,CAAC;AAAA,IAC7G,SACeC,GAAK;AACR,aAAO,KAAK,aAAa,SAASA,CAAG;AAAA,IACjD;AACQ,SAAK,WAAW,OACX,KAAK,MAAM;AACZ,WAAK,QAAS;AAAA,IACjB,CAAA,EACI,MAAM,CAACA,MAAQ;AAChB,WAAK,QAAQ,sBAAsBA,CAAG;AAAA,IAClD,CAAS,GAED,KAAK,WAAW,MAAM,KAAK,MAAM;AAC7B,WAAK,WAAW,0BAA2B,EAAC,KAAK,CAACC,MAAW;AACzD,cAAMC,IAAgBC,EAA0B,OAAO,kBAAkB,KAAK,OAAO,UAAU,GACzFC,IAASH,EAAO,SAAS,YAAYC,CAAa,EAAE,UAAW,GAC/DG,IAAgBC,EAA2B;AACjD,QAAAD,EAAc,SAAS,OAAOJ,EAAO,QAAQ,GAC7C,KAAK,UAAUI,EAAc,SAAS,UAAW;AACjD,cAAME,IAAO,MAAM;AACf,UAAAH,EACK,KAAI,EACJ,KAAK,CAAC,EAAE,MAAAI,GAAM,OAAAC,QAAY;AAC3B,YAAID,MAGJ,KAAK,SAASC,CAAK,GACnBF,EAAM;AAAA,UACT,CAAA,EACI,MAAM,CAACP,MAAQ;AAAA,UACxC,CAAqB;AAAA,QACJ;AACD,QAAAO,EAAM;AACN,cAAMG,IAAS,EAAE,MAAM,OAAQ;AAC/B,QAAI,KAAK,MAAM,QACXA,EAAO,OAAO,WAAW,KAAK,MAAM,GAAG,OAE3C,KAAK,QAAQ,MAAMA,CAAM,EAAE,KAAK,MAAM,KAAK,QAAQ;AAAA,MACnE,CAAa;AAAA,IACb,CAAS;AAAA,EACT;AAAA,EACI,MAAMC,GAAS;AACX,SAAK,WAAW;AAChB,aAASC,IAAI,GAAGA,IAAID,EAAQ,QAAQC,KAAK;AACrC,YAAMF,IAASC,EAAQC,CAAC,GAClBC,IAAaD,MAAMD,EAAQ,SAAS;AAC1C,WAAK,QAAQ,MAAMD,CAAM,EAAE,KAAK,MAAM;AAClC,QAAIG,KACAC,EAAS,MAAM;AACX,eAAK,WAAW,IAChB,KAAK,aAAa,OAAO;AAAA,QACjD,GAAuB,KAAK,YAAY;AAAA,MAExC,CAAa;AAAA,IACb;AAAA,EACA;AAAA,EACI,UAAU;AACN,QAAIC;AACJ,KAACA,IAAK,KAAK,gBAAgB,QAAQA,MAAO,UAAkBA,EAAG,MAAO;AAAA,EAC9E;AACA;","x_google_ignoreList":[0]}