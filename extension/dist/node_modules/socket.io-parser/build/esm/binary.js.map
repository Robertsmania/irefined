{"version":3,"file":"binary.js","sources":["../../../../../node_modules/socket.io-parser/build/esm/binary.js"],"sourcesContent":["import { isBinary } from \"./is-binary.js\";\n/**\n * Replaces every Buffer | ArrayBuffer | Blob | File in packet with a numbered placeholder.\n *\n * @param {Object} packet - socket.io event packet\n * @return {Object} with deconstructed packet and list of buffers\n * @public\n */\nexport function deconstructPacket(packet) {\n    const buffers = [];\n    const packetData = packet.data;\n    const pack = packet;\n    pack.data = _deconstructPacket(packetData, buffers);\n    pack.attachments = buffers.length; // number of binary 'attachments'\n    return { packet: pack, buffers: buffers };\n}\nfunction _deconstructPacket(data, buffers) {\n    if (!data)\n        return data;\n    if (isBinary(data)) {\n        const placeholder = { _placeholder: true, num: buffers.length };\n        buffers.push(data);\n        return placeholder;\n    }\n    else if (Array.isArray(data)) {\n        const newData = new Array(data.length);\n        for (let i = 0; i < data.length; i++) {\n            newData[i] = _deconstructPacket(data[i], buffers);\n        }\n        return newData;\n    }\n    else if (typeof data === \"object\" && !(data instanceof Date)) {\n        const newData = {};\n        for (const key in data) {\n            if (Object.prototype.hasOwnProperty.call(data, key)) {\n                newData[key] = _deconstructPacket(data[key], buffers);\n            }\n        }\n        return newData;\n    }\n    return data;\n}\n/**\n * Reconstructs a binary packet from its placeholder packet and buffers\n *\n * @param {Object} packet - event packet with placeholders\n * @param {Array} buffers - binary buffers to put in placeholder positions\n * @return {Object} reconstructed packet\n * @public\n */\nexport function reconstructPacket(packet, buffers) {\n    packet.data = _reconstructPacket(packet.data, buffers);\n    delete packet.attachments; // no longer useful\n    return packet;\n}\nfunction _reconstructPacket(data, buffers) {\n    if (!data)\n        return data;\n    if (data && data._placeholder === true) {\n        const isIndexValid = typeof data.num === \"number\" &&\n            data.num >= 0 &&\n            data.num < buffers.length;\n        if (isIndexValid) {\n            return buffers[data.num]; // appropriate buffer (should be natural order anyway)\n        }\n        else {\n            throw new Error(\"illegal attachments\");\n        }\n    }\n    else if (Array.isArray(data)) {\n        for (let i = 0; i < data.length; i++) {\n            data[i] = _reconstructPacket(data[i], buffers);\n        }\n    }\n    else if (typeof data === \"object\") {\n        for (const key in data) {\n            if (Object.prototype.hasOwnProperty.call(data, key)) {\n                data[key] = _reconstructPacket(data[key], buffers);\n            }\n        }\n    }\n    return data;\n}\n"],"names":["deconstructPacket","packet","buffers","packetData","pack","_deconstructPacket","data","isBinary","placeholder","newData","i","key","reconstructPacket","_reconstructPacket"],"mappings":";AAQO,SAASA,EAAkBC,GAAQ;AACtC,QAAMC,IAAU,CAAE,GACZC,IAAaF,EAAO,MACpBG,IAAOH;AACb,SAAAG,EAAK,OAAOC,EAAmBF,GAAYD,CAAO,GAClDE,EAAK,cAAcF,EAAQ,QACpB,EAAE,QAAQE,GAAM,SAASF,EAAS;AAC7C;AACA,SAASG,EAAmBC,GAAMJ,GAAS;AACvC,MAAI,CAACI;AACD,WAAOA;AACX,MAAIC,EAASD,CAAI,GAAG;AAChB,UAAME,IAAc,EAAE,cAAc,IAAM,KAAKN,EAAQ,OAAQ;AAC/D,WAAAA,EAAQ,KAAKI,CAAI,GACVE;AAAA,EACf,WACa,MAAM,QAAQF,CAAI,GAAG;AAC1B,UAAMG,IAAU,IAAI,MAAMH,EAAK,MAAM;AACrC,aAASI,IAAI,GAAGA,IAAIJ,EAAK,QAAQI;AAC7B,MAAAD,EAAQC,CAAC,IAAIL,EAAmBC,EAAKI,CAAC,GAAGR,CAAO;AAEpD,WAAOO;AAAA,EACf,WACa,OAAOH,KAAS,YAAY,EAAEA,aAAgB,OAAO;AAC1D,UAAMG,IAAU,CAAE;AAClB,eAAWE,KAAOL;AACd,MAAI,OAAO,UAAU,eAAe,KAAKA,GAAMK,CAAG,MAC9CF,EAAQE,CAAG,IAAIN,EAAmBC,EAAKK,CAAG,GAAGT,CAAO;AAG5D,WAAOO;AAAA,EACf;AACI,SAAOH;AACX;AASO,SAASM,EAAkBX,GAAQC,GAAS;AAC/C,SAAAD,EAAO,OAAOY,EAAmBZ,EAAO,MAAMC,CAAO,GACrD,OAAOD,EAAO,aACPA;AACX;AACA,SAASY,EAAmBP,GAAMJ,GAAS;AACvC,MAAI,CAACI;AACD,WAAOA;AACX,MAAIA,KAAQA,EAAK,iBAAiB,IAAM;AAIpC,QAHqB,OAAOA,EAAK,OAAQ,YACrCA,EAAK,OAAO,KACZA,EAAK,MAAMJ,EAAQ;AAEnB,aAAOA,EAAQI,EAAK,GAAG;AAGvB,UAAM,IAAI,MAAM,qBAAqB;AAAA,EAEjD,WACa,MAAM,QAAQA,CAAI;AACvB,aAASI,IAAI,GAAGA,IAAIJ,EAAK,QAAQI;AAC7B,MAAAJ,EAAKI,CAAC,IAAIG,EAAmBP,EAAKI,CAAC,GAAGR,CAAO;AAAA,WAG5C,OAAOI,KAAS;AACrB,eAAWK,KAAOL;AACd,MAAI,OAAO,UAAU,eAAe,KAAKA,GAAMK,CAAG,MAC9CL,EAAKK,CAAG,IAAIE,EAAmBP,EAAKK,CAAG,GAAGT,CAAO;AAI7D,SAAOI;AACX;","x_google_ignoreList":[0]}